# Automation Workflow

`ci_tools.ci` is the engine that drives Codex-assisted CI repair loops. This
document explains how the loop is orchestrated, how patches are vetted, and how
automation interacts with Git.

## High-Level Flow
1. **Preflight**
   - Parse CLI flags and dotenv defaults (`--env-file`, default `~/.env`)
   - Ensure the Git repository is on a branch (detached HEAD is rejected)
   - Validate the requested Codex model (`gpt-5-codex`) and reasoning effort
2. **Iteration Loop**
   - Run the user-specified CI command (default `./scripts/ci.sh`)
   - Capture stdout/stderr, optionally trim to the last `--log-tail` lines
   - If the command fails, summarize the failure and prompt Codex for a patch
   - Apply the patch with multiple safety checks; retry up to `--patch-retries`
3. **Coverage Mode**
   - When CI succeeds but coverage falls below the configured threshold,
     generate a targeted summary and request additional tests from Codex
4. **Commit Phase**
   - Optionally run `git add -A` (`--auto-stage` or automation mode)
   - Request a commit message when `--commit-message` is set or when executing
     the legacy CI shell (`ci.sh`)
   - Create a commit, and push automatically when in automation mode

## Command-Line Reference

| Flag | Purpose |
| ---- | ------- |
| `--command` | CI command to execute (`./scripts/ci.sh` default) |
| `--max-iterations` | Maximum Codex fix attempts (default: 5) |
| `--log-tail` | Number of log lines passed to Codex (default: 200) |
| `--model` | Override `OPENAI_MODEL` (must equal `gpt-5-codex`) |
| `--reasoning-effort` | Hint (`low`, `medium`, or `high`) for Codex |
| `--max-patch-lines` | Abort if Codex touches more than N lines (default: 1500) |
| `--patch-approval-mode` | `prompt` (default) or `auto` patch application |
| `--auto-stage` | Automatically run `git add -A` after CI succeeds |
| `--commit-message` | Ask Codex to draft the commit summary/body |
| `--commit-extra-context` | Additional instructions for the commit prompt |
| `--dry-run` | Execute the CI command once and exit without Codex |
| `--env-file` | Path to dotenv file for Codex CLI defaults |
| `--patch-retries` | Extra patch attempts when `git apply` fails |

### Environment Variables
- `OPENAI_MODEL` and `OPENAI_REASONING_EFFORT` can be pre-set via the dotenv file
- `CI_AUTOMATION=1` is injected when the command basename is `ci.sh`
- `GIT_REMOTE` overrides the remote used during the push phase (`origin` default)

## Patch Application Strategy
Patches suggested by Codex are applied conservatively:
1. `git apply --check`
2. If already applied, attempt `git apply --check --reverse`
3. Fall back to `patch -p1` with dry-run validation
4. Abort if safety guards detect risky patterns or protected files

Protected file prefixes and paths are taken from `ci_shared.config.json` and
hard-coded defaults to keep the CI infrastructure immutable.

## Failure Summaries
When a CI iteration fails, the tool assembles a focused prompt containing:
- The trimmed log tail
- File-specific diffs when available
- Any coverage deficits (module path and percentage)

This keeps prompts actionable and within Codex token limits.

## Coverage Handling
If CI passes but coverage is below threshold:
- Extract deficits from pytest coverage output
- Present an actionable summary to Codex
- Request targeted tests so each module clears the threshold
- Re-run the CI command to confirm the fix

## Commit and Push
- Commit summaries are generated by Codex when automation mode is active
- Bodies can include multi-line details provided by the Codex response
- Pushing is automatic in automation mode; otherwise, use `--push` via the shell
- Failures in `git commit` or `git push` raise `GitCommandAbort`

## Operating Modes
- **Dry Run**: `--dry-run` executes the command once and exits with its status
- **Legacy CLI**: Running through `xci.sh` preserves historical behavior while
  delegating the heavy lifting to `ci_tools.ci`
- **Prompt Approval**: Default mode requires manual confirmation before applying
  each patch, ideal for guarded or experimental scenarios
- **Auto Approval**: Combine `--patch-approval-mode auto` with reliable CI to
  loop unattended inside automation pipelines
